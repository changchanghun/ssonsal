<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>ì´ë™ ì¤‘</title>
	<link rel="stylesheet" href="/css/app.css" />
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="/js/app.js"></script>
</head>
<body class="dark">
<div th:replace="common/loading :: loading"></div>
	<div class="topbar">
		<h1>ì´ë™ ì¤‘</h1>
		<div class="end" style="cursor:pointer; right:16px; top: 50%; left:auto; color:#e5e7eb; position:absolute; transform: translateY(-50%);" >ì¢…ë£Œ</div>
	</div>
	<div class="time-box">
		<span id="timer">00:00</span>
	</div>
	<div class="container">
		<div class="pill">
			<span class="status">í˜„ì¬ ìƒíƒœ</span>
			  ì»¨ë””ì…˜ 
			<span class="status-data"> ë³´í†µ </span>
		</div>

		<div class="success-box" style="display:none;">
			<h3 style="margin:16px 0 8px">ì™„ë£Œí•œ ì‘ì—…</h3>
			<div class="card success">
				<p class="empty-message">-</p>
			</div>
		</div>

		<div class="card" style="margin-top:16px;">
			<div th:each="todo : ${todos}"
				 th:if="${todo.status.name() == 'PENDING'}"
				 th:class="'todo-item ' + ${todo.level.toString().toLowerCase()}"
				 th:attr="data-id=${todo.id}">
				<div class="todo-left">
					<span class="level" th:switch="${todo.level.name()}">
						<span th:case="LOW">â—</span>
						<span th:case="NORMAL">â—â—</span>
						<span th:case="HARD">â—â—â—</span>
					</span>
					<span class="text" th:text="${todo.title}"></span>
				</div>
				<span class="success-btn">ğŸ”„</span>
			</div>
		</div>
	</div>
</body>
</html> 
<script>
	// ì¹´ìš´íŠ¸
	let seconds = 0;
	let formatted = ``;
	function updateTimer() {
	  seconds++;

	  let minutes = Math.floor(seconds / 60);
	  let remainingSeconds = seconds % 60;
	  formatted = `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;

	  $('#timer').text(formatted);
	}

	setInterval(updateTimer, 1000);

	let condition = localStorage.getItem("condition");
	let sessionId = localStorage.getItem("sessionId");
	let ch_condition = "";
	switch(condition){
		case "BAD" :
			ch_condition = "ìµœì•…";
			break;
		case "NORMAL" :
			ch_condition = "ë³´í†µ";
			break;
		case "GOOD" :
			ch_condition = "ìµœê³ ";
			break;
	};

	localStorage.removeItem("condition");
	$(".status-data").text(ch_condition);

	// ì™„ë£Œ
	$(".success-btn").on("click", function(){
		let button = $(this);
		let id = $(this).parent().data("id");
		let text = $(this).parent().find('.text').text();
		let level = $(this).parent().find('.level span').text();

		let [minStr, secStr] = formatted.split(":");
		let minutes = parseInt(minStr, 10);
		let seconds = parseInt(secStr, 10);
		let count;

		// ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©
		let completed = JSON.parse(localStorage.getItem("completedTasks") || "[]");
		completed.push({ id, text, level });

		localStorage.setItem("completedTasks", JSON.stringify(completed));

		if(minutes > 0){
			count = minutes+"ë¶„";
		}else{
			count = seconds+"ì´ˆ";
		}

		$.ajax({
			url: `/api/todos/${id}/complete?sessionId=${sessionId}`,
			type: "POST",
			success: function (response) {
				button.parent().css("display","none");
				$(".success-box").css("display","block");
				$(".empty-message").css("display","none");
				$(".card.success").append('<div class="todo-item" style="cursor:unset;"><div class="todo-left">'+level+'<span class="line">'+text+'</span></div><span class="time-chip">-'+count+'</span></div>');
			},
			error: function (xhr, status, error) {
				alert("ì˜¤ë¥˜: " + xhr.responseText);
				return false;
			}
		});
	})

	$(".end").on("click", function(){
		localStorage.setItem("finalTimer", formatted);
		location.href="/trip-end";
	});
</script>